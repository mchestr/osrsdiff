[tools]
python = "3.11"
uv = "latest"

[tasks.help]
description = "Show available tasks"
run = """
echo "Available tasks:"
echo ""
echo "Development:"
echo "  mise run install      - Install production dependencies"
echo "  mise run dev-install  - Install development dependencies"
echo "  mise run dev          - Start backend development server on port 8000"
echo "  mise run frontend     - Run frontend development server"
echo "  mise run worker       - Start background worker"
echo ""
echo "Code Quality:"
echo "  mise run test         - Run tests"
echo "  mise run test:cov     - Run tests with coverage"
echo "  mise run lint         - Run linting"
echo "  mise run format       - Format code"
echo "  mise run typecheck    - Run type checking"
echo "  mise run ci           - Run CI checks (format, typecheck, frontend lint)"
echo ""
echo "Docker:"
echo "  mise run docker:up    - Start development environment"
echo "  mise run docker:down  - Stop development environment"
echo "  mise run docker:logs  - View logs from all services"
echo "  mise run docker:build - Build Docker images"
echo ""
echo "Database:"
echo "  mise run db:upgrade   - Run database migrations"
echo "  mise run db:downgrade - Rollback database migration"
echo "  mise run db:revision  - Create new database migration"
echo "  mise run db:init      - Initialize database with tables"
echo "  mise run db:reset     - Reset database (drop and recreate)"
echo ""
echo "Utilities:"
echo "  mise run clean        - Clean up build artifacts"
"""

[tasks.install]
description = "Install production dependencies"
run = "uv sync --no-dev"

[tasks.dev-install]
description = "Install development dependencies"
run = "uv sync --all-groups"

[tasks.dev]
description = "Start backend development server on port 8000"
run = "uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"

[tasks.frontend]
description = "Run frontend development server (configured to call API on port 8000)"
run = "cd frontend && npm run dev"

[tasks.worker]
description = "Start background worker"
run = "uv run taskiq worker app.workers.main:broker"

[tasks.test]
description = "Run tests"
run = "uv run python -m pytest"

[tasks."test:cov"]
description = "Run tests with coverage"
run = "uv run python -m pytest --cov=app --cov-report=html --cov-report=term"

[tasks.lint]
description = "Run linting"
run = """
uv run black --check app/ tests/
uv run isort --check app/ tests/
uv run mypy app/
"""

[tasks.format]
description = "Format code"
run = """
uv run black app/ tests/
uv run isort app/ tests/
"""

[tasks.typecheck]
description = "Run type checking"
run = "uv run mypy app/"

[tasks.ci]
description = "Run CI checks (format code, typecheck, frontend lint)"
run = """
uv run black app/ tests/
uv run mypy app/
cd frontend && npm run lint
npm run build
"""

[tasks.clean]
description = "Clean up build artifacts"
run = """
rm -rf build/
rm -rf dist/
rm -rf *.egg-info/
find . -type d -name __pycache__ -delete
find . -type f -name "*.pyc" -delete
"""

[tasks."docker:up"]
description = "Start development environment"
run = "docker-compose up -d"

[tasks."docker:down"]
description = "Stop development environment"
run = "docker-compose down"

[tasks."docker:logs"]
description = "View logs from all services"
run = "docker-compose logs -f"

[tasks."docker:build"]
description = "Build Docker images"
run = "docker-compose build"

[tasks."db:upgrade"]
description = "Run database migrations"
run = "DATABASE_URL=postgresql+asyncpg://osrs_diff:osrs_diff_password@localhost:5432/osrs_diff uv run alembic upgrade head"

[tasks."db:downgrade"]
description = "Rollback database migration"
run = "DATABASE_URL=postgresql+asyncpg://osrs_diff:osrs_diff_password@localhost:5432/osrs_diff uv run alembic downgrade -1"

[tasks."db:revision"]
description = "Create new database migration"
run = "DATABASE_URL=postgresql+asyncpg://osrs_diff:osrs_diff_password@localhost:5432/osrs_diff uv run alembic revision --autogenerate -m \"${MESSAGE:-New migration}\""

[tasks."db:init"]
description = "Initialize database with tables (alternative to migrations)"
run = "DATABASE_URL=postgresql+asyncpg://osrs_diff:osrs_diff_password@localhost:5432/osrs_diff uv run python scripts/manage_db.py create"

[tasks."db:reset"]
description = "Reset database (drop and recreate tables)"
run = """
DATABASE_URL=postgresql+asyncpg://osrs_diff:osrs_diff_password@localhost:5432/osrs_diff uv run python scripts/manage_db.py drop
DATABASE_URL=postgresql+asyncpg://osrs_diff:osrs_diff_password@localhost:5432/osrs_diff uv run python scripts/manage_db.py create
"""
